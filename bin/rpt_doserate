#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import click
import rpt_dosi as rpt
import opengate as gate
from pathlib import Path

CONTEXT_SETTINGS = dict(help_option_names=["-h", "--help"])


@click.command(context_settings=CONTEXT_SETTINGS)
@click.option("--ct_filename", "-i", required=True, help="CT filename")
@click.option(
    "--activity_filename", "-j", required=True, help="Activity (SPECT) filename"
)
@click.option("--rad", "-r", default="Lu177", help="Radionuclide")
@click.option("--nb_threads", "-t", default=1, help="Number of threads")
@click.option("--activity_bq", "-a", default=1e5, help="Total activity in Bq")
@click.option("--dtol", default=0.2, help="Density tolerance in gcm3")
@click.option("--output_folder", "-o", required=True, help="output folder")
def go(
    ct_filename, activity_filename, rad, nb_threads, activity_bq, dtol, output_folder
):
    """ """

    # create simulation
    sim = gate.Simulation()
    sim.output = Path(output_folder)
    output_folder = Path(output_folder)
    # sim.visu = True
    rpt.doserate.simu_default_init(sim)
    # ct
    ct = rpt.doserate.simu_add_ct(sim, ct_filename, dtol)
    # activity spect
    source = rpt.doserate.simu_add_activity_source(
        sim,
        ct,
        activity_filename,
        rad,
    )
    # dose map
    dose = rpt.doserate.add_dose_actor(sim, ct, source)

    # activity and output
    Bq = gate.g4_units.Bq
    sim.number_of_threads = nb_threads
    source.activity = activity_bq * Bq / sim.number_of_threads
    dose.output = "edep.mhd"
    sim.get_actor_user_info("stats").output = output_folder / "stats.txt"

    # go
    sim.run()

    # print stats
    stats = sim.output.get_actor("stats")
    print(stats)


# --------------------------------------------------------------------------
if __name__ == "__main__":
    go()
