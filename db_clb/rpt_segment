#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import click
import os
import subprocess

CONTEXT_SETTINGS = dict(help_option_names=["-h", "--help"])


@click.command(context_settings=CONTEXT_SETTINGS)
@click.argument("pname")
def go(pname):
    # Define the base directory
    base_dir = pname

    # Recursively iterate through subdirectories
    for root, dirs, files in os.walk(base_dir):
        # Check if the current directory contains ct.nii.gz
        if "ct.nii.gz" in files:
            # Extract relevant information from the directory structure
            dir_parts = root[len(base_dir) + 1 :].split(os.path.sep)

            # Check if the directory structure follows the expected pattern
            if len(dir_parts) == 2:
                cycle, tp = dir_parts
                cwd = os.getcwd()
                cmd = f"TotalSegmentator -i ct.nii.gz -bs -o rois -ta body ; TotalSegmentator -i ct.nii.gz -bs -o rois"

                # Execute the TotalSegmentator command in the current directory
                print(f"cd {root} ; {cmd} ; cd {cwd}")
                # subprocess.run(command, cwd=root)

                # You can print or perform additional actions based on cycle and tp
                # print(f"Processed cycle: {cycle}, tp: {tp}")


# --------------------------------------------------------------------------
if __name__ == "__main__":
    go()
